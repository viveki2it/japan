class Nextdoorz.Views.NewBoardDistrict extends Nextdoorz.Views.BaseWizardStep
  @listenerSet: false
  title: "Choisissez vos quartiers à Paris"
  prevViewName: 'NewBoardSubcategory'
  nextViewName: undefined
  className: 'u-step3'
  template: Nextdoorz.getTemplate('boards/wizard/district')
  paper: undefined
  fragments:
    {}
  beforeHide: ()->
    that = this
    that.model.set('district_ids', [])
    _.each @fragments, (rPath, key)->
      if rPath.data 'sel'
        sId = key.slice key.indexOf('_') + 1, key.length
        id = parseInt sId, 10
        that.model.get('district_ids').push id
    super
  currentFragment: undefined
  _mouseMoveListener: (e)->
    window.mouseX = e.pageX
    window.mouseY = e.pageY
  _drawMap: ($map)->
    that = this

    paper = @paper = new Raphael $map[0], 500, 350
    paper.setViewBox 200, 0, 800, 800, true

    @fragments = {}

    attr =
      fill: "#f5f5f5",
      stroke: "#d5d5d5",
      "stroke-width": 2,
      "stroke-linejoin": "round"

    # draw paths
    @fragments.arr_16 = paper.path("M 190.14348,559.79467 L 183.46807,557.5 L 154.33273,553.7406 L 120.49814,520.84587 L 115.79889,484.19173 L 129.89664,465.39474 L 152.45303,467.27444 L 158.09213,453.17669 L 187.22746,391.14662 L 219.18235,329.11654 L 243.61844,281.18421 L 273.69363,248.28947 L 275.53165,243.08175 L 276.51318,242.65038 L 338.54325,268.96617 L 347.94175,289.64286 L 362.03949,328.17669 L 370.49814,345.09399 L 370.17877,345.41828 L 345.1222,349.79323 L 317.86656,381.74812 L 273.69363,430.6203 C 273.69363,430.6203 216.33967,519.18768 189.68883,559.70365").attr(attr).data('arr', '16ème')
    @fragments.arr_09 = paper.path("M 500.66732,298.1015 L 490.79889,281.18421 L 495.49814,260.50752 L 495.02821,192.83835 L 514.29513,184.3797 L 554.70867,200.35714 L 606.4004,185.31955 L 608.20316,185.17573 L 608.2801,185.31955 L 610.62973,291.99248 L 564.10716,282.12406 L 500.66732,298.1015 z").attr(attr).data('arr', '9ème')
    @fragments.arr_18 = paper.path("M 704.82561,45.281956 L 709.78386,106.37218 L 680.64852,175.92105 L 679.70867,177.80075 L 645.87408,178.7406 L 608.12622,185.03191 L 606.4004,185.31955 L 554.70867,200.35714 L 514.29513,184.3797 L 494.08837,193.30827 L 494.55829,186.2594 L 486.09965,163.70301 L 501.58429,53.922222 L 510.53574,53.740602 L 572.56581,52.800753 L 642.11468,45.281956 L 704.82561,45.281956 z").attr(attr).data('arr', '18ème')
    @fragments.arr_19 = paper.path("M 678.76882,176.8609 L 682.52822,176.8609 L 707.90416,184.3797 L 707.90416,193.7782 L 716.3628,236.07143 L 748.31769,276.02522 L 818.20699,254.01 L 830.42504,258.70925 L 863.31977,256.82955 L 889.63556,247.43106 L 913.56101,235.33233 L 902.45303,212.57519 L 877.07709,208.81579 L 855.46055,190.0188 L 852.641,162.76316 L 851.70115,127.04887 L 841.3628,94.15414 L 826.32521,68.778196 L 799.06957,47.161655 L 753.95679,43.402256 L 704.82561,45.281956 L 709.78386,106.37218 L 680.64852,175.92105").attr(attr).data('arr', '19ème')
    @fragments.arr_20 = paper.path("M 936.5691,464.4838 L 849.22203,456.07767 L 849.22203,446.67918 L 845.46263,427.88218 L 831.36489,399.6867 L 815.38744,382.7694 L 806.9288,380.8897 L 797.5303,347.99497 L 749.25754,276.50532 L 818.20699,254.01 L 830.42504,258.70925 L 863.31977,256.82955 L 889.63556,247.43106 L 913.72105,235.6524 L 924.06957,285.88346 L 929.70867,337.57519 L 935.34777,383.62782 L 937.22746,434.3797 L 936.5691,464.4838 z").attr(attr).data('arr', '20ème')
    @fragments.arr_15 = paper.path("M 317.39664,381.74812 L 273.69363,430.6203 C 273.69363,430.6203 215.89957,520.10788 189.6961,560.20926 L 213.54325,567.83834 L 232.34025,561.2594 L 251.13724,580.52632 L 291.55077,601.67293 L 348.8816,633.62782 L 369.11574,640.12921 L 378.01694,627.98872 L 390.23498,615.77068 L 423.12972,575.35714 L 459.78386,522.72556 L 473.8816,516.14662 L 482.34025,490.77068 L 450.38536,472.91353 L 440.04701,478.55263 L 431.58837,477.61278 L 412.79137,465.39474 L 405.27258,471.03384 L 317.39664,381.74812 z").attr(attr).data('arr', '15ème')
    @fragments.arr_14 = paper.path("M 369.11574,640.12921 L 415.61092,654.30451 L 486.09965,674.04135 L 509.59589,688.1391 L 551.88912,705.99624 L 583.94089,702.2968 L 584.78386,692.83835 L 581.02446,668.40226 L 571.62596,631.74812 L 570.68611,610.13158 L 564.10716,580.05639 L 565.98686,565.95865 L 575.88602,531.78643 L 544.37032,522.72556 L 482.81018,491.24061 L 473.8816,516.14662 L 459.78386,522.72556 L 423.12972,575.35714 L 390.23498,615.77068 L 378.01694,627.98872 L 369.11574,640.12921 z").attr(attr).data('arr', '14ème')
    @fragments.arr_13 = paper.path("M 583.94089,702.2968 L 584.78386,692.83835 L 581.02446,668.40226 L 571.62596,631.74812 L 570.68611,610.13158 L 564.10716,580.05639 L 565.98686,565.95865 L 575.88602,531.78643 L 597.94175,537.76316 L 622.37784,541.52256 L 663.73122,519.90602 L 689.53331,480.66577 L 780.27258,580.99624 L 810.84493,618.2508 L 790.61092,630.80827 L 744.55829,656.18421 L 698.50566,688.1391 C 698.50566,688.1391 655.27258,693.7782 651.51318,693.7782 C 647.75378,693.7782 623.31769,687.19925 623.31769,687.19925 L 601.70115,700.35714 L 583.94089,702.2968 z").attr(attr).data('arr', '13ème')
    @fragments.arr_05 = paper.path("M 689.79247,480.953 L 663.73122,519.90602 L 622.37784,541.52256 L 597.94175,537.76316 L 575.44683,531.44879 L 544.37032,523.66541 L 583.37409,414.17294 L 614.85904,428.7406 L 625.19739,429.68045 L 644.93423,441.8985 L 667.49062,455.99624 L 689.79247,480.953 z").attr(attr).data('arr', '5ème')
    @fragments.arr_06 = paper.path("M 582.79658,414.75044 L 568.59125,400.76027 L 546.03486,381.96328 L 529.51276,374.10438 L 518.99438,404.30451 L 511.47558,420.28196 L 503.01694,436.2594 L 450.85528,473.85338 L 482.81018,491.24061 L 544.37032,523.66541 L 582.79658,414.75044 z").attr(attr).data('arr', '6ème')
    @fragments.arr_07 = paper.path("M 316.81913,382.32562 L 405.27258,471.03384 L 412.79137,465.39474 L 431.58837,477.61278 L 440.04701,478.55263 L 450.85528,473.85338 L 503.01694,436.2594 L 511.47558,420.28196 L 518.99438,404.30451 L 529.23566,373.98494 L 491.52358,358.46704 L 442.6514,340.6099 L 403.17772,340.6099 L 369.02376,346.57329 L 343.96719,350.94824 L 316.81913,382.32562 z").attr(attr).data('arr', '7ème')
    @fragments.arr_08 = paper.path("M 370.60414,345.25613 L 362.30517,328.17669 L 348.20743,289.64286 L 337.39916,268.96617 L 351.02698,238.89098 L 494.82397,193.30827 L 495.76382,260.50752 L 491.06457,281.18421 L 501.40292,297.16165 L 490.12472,302.80075 L 480.72623,319.71805 L 471.38302,348.68381 L 444.07209,339.45489 L 404.59841,339.45489 L 370.60414,345.25613 z").attr(attr).data('arr', '8ème')
    @fragments.arr_17 = paper.path("M 501.58429,53.922222 L 486.09965,163.70301 L 494.55829,186.2594 L 493.61844,193.7782 L 350.7613,238.89098 L 337.13348,268.96617 L 276.02242,242.86607 L 279.33273,232.31203 L 247.37784,236.07143 L 253.95679,214.45489 L 272.75378,182.5 L 318.80641,136.44737 L 366.73874,105.43233 L 409.97183,79.116542 L 461.66355,55.620301 L 501.58429,53.922222 z").attr(attr).data('arr', '17ème')
    @fragments.arr_12 = paper.path("M 848.58189,451.25436 L 849.22203,456.07767 L 936.5691,464.4838 L 935.34777,466.33459 L 926.88912,491.71053 L 925.94927,510.50752 L 911.85152,552.80075 L 886.47558,545.28196 L 852.641,569.71805 L 864.85905,584.75564 L 831.02446,604.49248 L 810.84493,618.2508 L 780.27258,580.99624 L 680.80342,470.50847 L 682.52822,459.75564 L 697.56581,464.45489 L 711.66355,417.46241 L 737.03949,429.68045 L 848.58189,451.25436 z").attr(attr).data('arr', '12ème')
    @fragments.arr_11 = paper.path("M 673.59965,312.19925 L 748.31769,276.02522 L 797.5303,347.99497 L 806.9288,380.8897 L 815.38744,382.7694 L 831.36489,399.6867 L 845.46263,427.88218 L 849.22203,446.67918 L 848.58189,453.68733 L 737.03949,429.68045 L 711.04377,417.76212 L 702.26506,393.96617 L 692.86656,348.85338 L 683.46807,322.53759 L 673.59965,312.19925 z").attr(attr).data('arr', '11ème')
    @fragments.arr_03 = paper.path("M 630.00618,298.83331 L 616.89228,338.77689 L 612.97934,350.26315 L 643.05453,362.01128 L 704.45896,401.42913 L 702.26506,393.96617 L 692.86656,348.85338 L 683.46807,322.53759 L 673.59965,312.19925 L 630.00618,298.83331 z").attr(attr).data('arr', '3ème')
    @fragments.arr_04 = paper.path("M 704.45896,401.42913 L 711.04377,417.76212 L 697.56581,464.45489 L 682.52822,459.75564 L 680.71286,470.4081 L 667.49062,455.99624 L 644.93423,441.8985 L 625.19739,429.68045 L 614.85904,428.7406 L 584.78386,413.23309 L 596.06205,395.84587 L 612.97934,349.79323 L 643.05453,362.01128 L 704.45896,401.42913 z").attr(attr).data('arr', '4ème')
    @fragments.arr_10 = paper.path("M 607.34025,185.31955 L 610.1598,292.46241 L 674.06957,312.19925 L 747.37784,275.54511 L 716.3628,236.07143 L 707.90416,193.7782 L 707.90416,184.3797 L 682.52822,176.8609 L 679.70867,176.39098 L 679.70867,177.80075 L 645.87408,178.7406 L 608.12622,185.03191 L 607.34025,185.31955 z").attr(attr).data('arr', '10ème')
    @fragments.arr_02 = paper.path("M 610.62973,292.63262 L 564.10716,282.12406 L 499.8875,298.7111 L 518.05453,316.8985 L 597.0019,341.33459 L 616.81551,338.17604 L 630.00618,298.83331 L 610.62973,292.63262 z").attr(attr).data('arr', '2ème')
    @fragments.arr_01 = paper.path("M 470.91768,348.61086 L 492.67859,357.31203 L 547.18987,380.80827 L 569.74626,399.60526 L 584.78386,413.23309 L 596.06205,395.84587 L 612.97934,350.26315 L 616.81551,338.17604 L 597.0019,341.33459 L 518.05453,316.8985 L 500.19739,298.57142 L 489.85904,302.80075 L 480.46055,319.71805 L 470.91768,348.61086 z ").attr(attr).data('arr', '1er')

    _.each @fragments, (rPath, key)->
      rPath.color = "#0493AB"
      $path = $(rPath[0])
      $path.css 'cursor', 'pointer'

      $path.on 'mouseover', ()->
        that.currentFragment && that.fragments[that.currentFragment].animate {fill: "#f5f5f5"}, 300
        rPath.animate {fill: "#169ACF"}, 300
        that.paper.safari()
        # Show a tooltip
        $tooltip = $("<div class='district'>#{rPath.data 'arr'}</div>")
        $map.append $tooltip

      $path.on 'mouseout', ()->
        unless rPath.data('sel') == 1
          rPath.animate {fill: "#f5f5f5"}, 300
          that.paper.safari()
          # Remove tooltips
          $map.find('.district').remove()

      $path.on 'click', ()->
        rPath.attr fill: "#169ACF"
        $map.find('.district').html rPath.data('arr')
        $map.find('h3.dnone').removeClass 'dnone'
        unless rPath.data('sel') == 1
          $pill = $ Nextdoorz.getTemplate('boards/wizard/p_district_checkbox')(id: rPath.data('arr'))
          $map.find('.districts-wrap').append $pill
          rPath.data 'sel', 1
        else
          $map.find("#district_#{rPath.data 'arr'}").remove()
          rPath.data 'sel', 0

      sId = key.slice key.indexOf('_') + 1, key.length
      id = parseInt sId, 10
      if _.contains(that.model.get('district_ids'), id)
        rPath.attr fill: "#169ACF"
        $pill = $ Nextdoorz.getTemplate('boards/wizard/p_district_checkbox')(id: rPath.data('arr'))
        $map.find('.districts-wrap').append $pill
        rPath.data 'sel', 1




  initialize: ()->
    unless Nextdoorz.Views.NewBoardDistrict.listenerSet
      $(window).on 'mousemove', @_mouseMoveListener
      Nextdoorz.Views.NewBoardDistrict.listenerSet = true
  leave: ()->
    $(window).off 'mousemove', @_mouseMoveListener
    Nextdoorz.Views.NewBoardDistrict.listenerSet = false
    super
  render: ()->
    super
    $map = @$('#paris-map')
    @_drawMap $map
    this